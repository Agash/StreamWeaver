<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="StreamWeaver.UI.Views.SettingsPages.TtsSettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:StreamWeaver.UI.Views.SettingsPages"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:StreamWeaver.UI.ViewModels"
    xmlns:converters="using:StreamWeaver.UI.Converters"
    xmlns:settings="using:StreamWeaver.Core.Models.Settings"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:ui="using:CommunityToolkit.WinUI"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance Type=viewmodels:SettingsViewModel, IsDesignTimeCreatable=False}"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <x:Double x:Key="SettingsCardSpacing">4</x:Double>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter"/>
        <StaticResource x:Key="DecimalFormatter" ResourceKey="DecimalFormatter"/>
        <StaticResource x:Key="IntegerFormatter" ResourceKey="IntegerFormatter"/>
        <converters:EqualityToVisibilityConverter x:Key="EngineToVisibilityConverter"/>

        <!-- Helper style for format TextBoxes -->
        <Style x:Key="FormatTextBoxStyle" TargetType="TextBox">
            <Setter Property="AcceptsReturn" Value="True"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Setter Property="MinHeight" Value="60"/>
            <Setter Property="Margin" Value="0,5,0,0"/>
        </Style>

        <!-- Style for nested settings StackPanel -->
        <Style x:Key="NestedSettingsStackPanelStyle" TargetType="StackPanel">
            <Setter Property="Margin" Value="48,5,0,10"/>
            <!-- Indent -->
            <Setter Property="Spacing" Value="10"/>
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefault}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <!-- Bottom border -->
            <Setter Property="Padding" Value="0,0,0,10"/>
            <!-- Padding below border -->
        </Style>

    </Page.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
        <StackPanel Spacing="{StaticResource SettingsCardSpacing}">
            <TextBlock Text="Text-to-Speech (TTS)" Style="{ThemeResource SubtitleTextBlockStyle}" Margin="0,0,0,10"/>

            <!-- General Settings -->
            <controls:SettingsCard Header="Enable TTS" HeaderIcon="{ui:FontIcon Glyph=}">
                <ToggleSwitch IsOn="{Binding TtsSettings.Enabled, Mode=TwoWay}"/>
            </controls:SettingsCard>

            <controls:SettingsCard Header="TTS Engine" HeaderIcon="{ui:FontIcon Glyph=}" IsEnabled="{Binding TtsSettings.Enabled}">
                <RadioButtons ItemsSource="{Binding TtsEngineOptions}" SelectedItem="{Binding SelectedEngine, Mode=TwoWay}">
                    <RadioButtons.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding}"/>
                        </DataTemplate>
                    </RadioButtons.ItemTemplate>
                </RadioButtons>
            </controls:SettingsCard>

            <controls:SettingsCard Header="Windows Voice" HeaderIcon="{ui:FontIcon Glyph=}"
                                   IsEnabled="{Binding TtsSettings.Enabled}"
                                   Visibility="{Binding SelectedEngine, Converter={StaticResource EngineToVisibilityConverter}, ConverterParameter='Windows'}">
                <ComboBox ItemsSource="{Binding WindowsVoices}"
                          SelectedItem="{Binding SelectedWindowsVoice, Mode=TwoWay}"
                          PlaceholderText="Default System Voice" MinWidth="200"/>
            </controls:SettingsCard>

            <controls:SettingsCard Header="Kokoro Voice" HeaderIcon="{ui:FontIcon Glyph=}"
                                   IsEnabled="{Binding TtsSettings.Enabled}"
                                   Visibility="{Binding SelectedEngine, Converter={StaticResource EngineToVisibilityConverter}, ConverterParameter='Kokoro'}">
                <ComboBox ItemsSource="{Binding KokoroVoices}"
                          SelectedItem="{Binding SelectedKokoroVoice, Mode=TwoWay}"
                          PlaceholderText="No Kokoro voices found" MinWidth="200"/>
            </controls:SettingsCard>

            <controls:SettingsCard Header="Volume and Rate" HeaderIcon="{ui:FontIcon Glyph=}" IsEnabled="{Binding TtsSettings.Enabled}">
                <controls:SettingsCard.Resources>
                    <!-- Define the resource directly inside the card's resources -->
                    <x:Double x:Key="SettingsCardWrapThreshold">600</x:Double>
                </controls:SettingsCard.Resources>
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Slider Header="Volume" Minimum="0" Maximum="100" Value="{Binding TtsSettings.Volume, Mode=TwoWay}" TickFrequency="10" TickPlacement="Inline" StepFrequency="1" MinWidth="150"/>
                    <Slider Header="Rate" Minimum="-10" Maximum="10" Value="{Binding TtsSettings.Rate, Mode=TwoWay}" TickFrequency="1" TickPlacement="Inline" StepFrequency="1" MinWidth="150"/>
                </StackPanel>
            </controls:SettingsCard>

            <controls:SettingsCard Header="Test TTS" HeaderIcon="{ui:FontIcon Glyph=}" IsEnabled="{Binding TtsSettings.Enabled}">
                <StackPanel Spacing="10">
                    <TextBox Text="{Binding TtsTestPhrase, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" PlaceholderText="Enter text here to test TTS..." AcceptsReturn="True" TextWrapping="Wrap" MinHeight="80"/>
                    <Button Content="Test" Command="{Binding TestTtsCommand}" HorizontalAlignment="Left"/>
                </StackPanel>
            </controls:SettingsCard>

                    <!-- Twitch Events -->
                    <controls:SettingsExpander Header="Twitch Events" HeaderIcon="{ui:FontIcon Glyph=}" IsEnabled="{Binding TtsSettings.Enabled}">
                        <controls:SettingsExpander.Items>
                            <controls:SettingsCard Header="Subscriptions / Resubs / Gifts" HeaderIcon="{ui:FontIcon Glyph=}">
                                <ToggleSwitch x:Name="TwitchSubsToggle" IsOn="{Binding TtsSettings.ReadTwitchSubs, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=TwitchSubsToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <TextBox Header="New Sub Format" IsEnabled="{Binding IsOn, ElementName=TwitchSubsToggle}" Text="{Binding TtsSettings.NewSubMessageFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                                <TextBox Header="Resub Format" IsEnabled="{Binding IsOn, ElementName=TwitchSubsToggle}" Text="{Binding TtsSettings.ResubMessageFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                                <TextBox Header="Gift Sub Format" IsEnabled="{Binding IsOn, ElementName=TwitchSubsToggle}" Text="{Binding TtsSettings.GiftSubMessageFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                                <TextBox Header="Gift Bomb Format" IsEnabled="{Binding IsOn, ElementName=TwitchSubsToggle}" Text="{Binding TtsSettings.GiftBombMessageFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>

                            <controls:SettingsCard Header="Bits / Cheers" HeaderIcon="{ui:FontIcon Glyph=}">
                                <ToggleSwitch x:Name="TwitchBitsToggle" IsOn="{Binding TtsSettings.ReadTwitchBits, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=TwitchBitsToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <NumberBox Header="Minimum Bits to Read" Minimum="0" Value="{Binding TtsSettings.MinimumBitAmountToRead, Mode=TwoWay}" IsEnabled="{Binding IsOn, ElementName=TwitchBitsToggle}" NumberFormatter="{StaticResource IntegerFormatter}" SpinButtonPlacementMode="Inline" SmallChange="10" LargeChange="100"/>
                                <TextBox Header="Bits Format" Text="{Binding TtsSettings.BitsMessageFormat, Mode=TwoWay}" IsEnabled="{Binding IsOn, ElementName=TwitchBitsToggle}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>

                            <controls:SettingsCard Header="Raids" HeaderIcon="{ui:FontIcon Glyph=}">
                                <ToggleSwitch x:Name="TwitchRaidsToggle" IsOn="{Binding TtsSettings.ReadRaids, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=TwitchRaidsToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <NumberBox Header="Minimum Raid Viewers to Read" Minimum="0" Value="{Binding TtsSettings.MinimumRaidViewersToRead, Mode=TwoWay}" IsEnabled="{Binding IsOn, ElementName=TwitchRaidsToggle}" NumberFormatter="{StaticResource IntegerFormatter}" SpinButtonPlacementMode="Inline" SmallChange="1" LargeChange="10"/>
                                <TextBox Header="Raid Format" Text="{Binding TtsSettings.RaidMessageFormat, Mode=TwoWay}" IsEnabled="{Binding IsOn, ElementName=TwitchRaidsToggle}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>
                        </controls:SettingsExpander.Items>
                    </controls:SettingsExpander>

                    <!-- YouTube Events -->
                    <controls:SettingsExpander Header="YouTube Events" HeaderIcon="{ui:FontIcon Glyph=}" IsEnabled="{Binding TtsSettings.Enabled}">
                        <controls:SettingsExpander.Items>
                            <controls:SettingsCard Header="New Members" HeaderIcon="{ui:FontIcon Glyph=}">
                                <ToggleSwitch x:Name="YouTubeNewMembersToggle" IsOn="{Binding TtsSettings.ReadYouTubeNewMembers, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=YouTubeNewMembersToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <TextBox Header="New Member Format" IsEnabled="{Binding IsOn, ElementName=YouTubeNewMembersToggle}" Text="{Binding TtsSettings.NewMemberMessageFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>

                            <controls:SettingsCard Header="Member Milestones" HeaderIcon="{ui:FontIcon Glyph=}">
                                <ToggleSwitch x:Name="YouTubeMilestonesToggle" IsOn="{Binding TtsSettings.ReadYouTubeMilestones, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=YouTubeMilestonesToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <NumberBox Header="Minimum Milestone Months to Read" Minimum="1" Value="{Binding TtsSettings.MinimumMilestoneMonthsToRead, Mode=TwoWay}" IsEnabled="{Binding IsOn, ElementName=YouTubeMilestonesToggle}" NumberFormatter="{StaticResource IntegerFormatter}" SpinButtonPlacementMode="Inline" SmallChange="1" LargeChange="6"/>
                                <TextBox Header="Member Milestone Format" IsEnabled="{Binding IsOn, ElementName=YouTubeMilestonesToggle}" Text="{Binding TtsSettings.MemberMilestoneFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>

                            <controls:SettingsCard Header="Membership Gift Purchases (Gifter)" HeaderIcon="{ui:FontIcon Glyph=}">
                                <controls:SettingsCard.Description>Announce when a user purchases gift memberships for others.</controls:SettingsCard.Description>
                                <ToggleSwitch x:Name="YouTubeGiftPurchasesToggle" IsOn="{Binding TtsSettings.ReadYouTubeGiftPurchases, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=YouTubeGiftPurchasesToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <NumberBox Header="Minimum Gifted Memberships to Read" Minimum="1" Value="{Binding TtsSettings.MinimumGiftCountToRead, Mode=TwoWay}" IsEnabled="{Binding IsOn, ElementName=YouTubeGiftPurchasesToggle}" NumberFormatter="{StaticResource IntegerFormatter}" SpinButtonPlacementMode="Inline" SmallChange="1" LargeChange="5"/>
                                <TextBox Header="Gift Purchase Format" IsEnabled="{Binding IsOn, ElementName=YouTubeGiftPurchasesToggle}" Text="{Binding TtsSettings.GiftedMemberPurchaseFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>

                            <controls:SettingsCard Header="Membership Gift Redemptions (Recipient)" HeaderIcon="{ui:FontIcon Glyph=}">
                                <controls:SettingsCard.Description>Announce when a user receives a gifted membership.</controls:SettingsCard.Description>
                                <ToggleSwitch x:Name="YouTubeGiftRedemptionsToggle" IsOn="{Binding TtsSettings.ReadYouTubeGiftRedemptions, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=YouTubeGiftRedemptionsToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <TextBox Header="Gift Redemption Format" IsEnabled="{Binding IsOn, ElementName=YouTubeGiftRedemptionsToggle}" Text="{Binding TtsSettings.GiftedMemberRedemptionFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>

                            <controls:SettingsCard Header="Super Chats / Stickers" HeaderIcon="{ui:FontIcon Glyph=}">
                                <ToggleSwitch x:Name="YouTubeSuperChatsToggle" IsOn="{Binding TtsSettings.ReadSuperChats, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=YouTubeSuperChatsToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <NumberBox Header="Minimum Super Chat Amount" Minimum="0" Value="{Binding TtsSettings.MinimumSuperChatAmountToRead, Mode=TwoWay}" IsEnabled="{Binding IsOn, ElementName=YouTubeSuperChatsToggle}" NumberFormatter="{StaticResource DecimalFormatter}" SpinButtonPlacementMode="Inline" SmallChange="0.5" LargeChange="1"/>
                                <TextBox Header="SuperChat Format" IsEnabled="{Binding IsOn, ElementName=YouTubeSuperChatsToggle}" Text="{Binding TtsSettings.SuperChatMessageFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>
                        </controls:SettingsExpander.Items>
                    </controls:SettingsExpander>

                    <!-- Other Events -->
                    <controls:SettingsExpander Header="Other Events" HeaderIcon="{ui:FontIcon Glyph=}" IsEnabled="{Binding TtsSettings.Enabled}">
                        <controls:SettingsExpander.Items>
                            <controls:SettingsCard Header="Streamlabs Donations" HeaderIcon="{ui:FontIcon Glyph=}">
                                <ToggleSwitch x:Name="StreamlabsDonationsToggle" IsOn="{Binding TtsSettings.ReadStreamlabsDonations, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=StreamlabsDonationsToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <NumberBox Header="Minimum Donation Amount" Minimum="0" Value="{Binding TtsSettings.MinimumDonationAmountToRead, Mode=TwoWay}" IsEnabled="{Binding IsOn, ElementName=StreamlabsDonationsToggle}" NumberFormatter="{StaticResource DecimalFormatter}" SpinButtonPlacementMode="Inline" SmallChange="0.5" LargeChange="1"/>
                                <TextBox Header="Donation Format" IsEnabled="{Binding IsOn, ElementName=StreamlabsDonationsToggle}" Text="{Binding TtsSettings.DonationMessageFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>

                            <controls:SettingsCard Header="Follows" HeaderIcon="{ui:FontIcon Glyph=}">
                                <ToggleSwitch x:Name="FollowsToggle" IsOn="{Binding TtsSettings.ReadFollows, Mode=TwoWay}"/>
                            </controls:SettingsCard>
                            <StackPanel Style="{StaticResource NestedSettingsStackPanelStyle}" Opacity="{Binding IsOn, ElementName=FollowsToggle, Converter={StaticResource BoolToOpacityConverter}}">
                                <TextBox Header="Follow Format" IsEnabled="{Binding IsOn, ElementName=FollowsToggle}" Text="{Binding TtsSettings.FollowMessageFormat, Mode=TwoWay}" Style="{StaticResource FormatTextBoxStyle}"/>
                            </StackPanel>
                        </controls:SettingsExpander.Items>
                    </controls:SettingsExpander>
        </StackPanel>
    </ScrollViewer>
</Page>
